variables:
  - group: kv-project-dev-82uc

trigger:
  branches:
    include:
      - master
jobs:
  - job: Job_1
    displayName: Terraform Plan
    pool:
      vmImage: ubuntu-20.04
    steps:
      - checkout: self
        fetchDepth: 1
      - task: TerraformInstaller@0
        displayName: Install Terraform 1.3.7
        inputs:
          terraformVersion: 1.3.7
      - task: CmdLine@2
        displayName: Terraform init
        inputs:
          script: terraform init -backend-config="access_key=$(stterraformstate4321-key1)"
      - task: CmdLine@2
        displayName: Terraform Validate
        inputs:
          script: terraform validate
      - task: CmdLine@2
        displayName: Terraform Plan
        inputs:
          script: terraform plan -input=false -out=tfplan -var="spn-client-id=$(tf-project-pipeline-spn-client-id)" -var="spn-client-secret=$(tf-project-pipeline-spn-secret) -var="spn-tenant-id=$(tf-project-pipeline-spn-tenant-id)"
      - task: ArchiveFiles@2
        displayName: Archive Terraform Plan Files
        inputs:
          archiveType: tar
          archiveFile: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-tfplan.tgz
      - task: PublishPipelineArtifact@1
        displayName: Publish Terraform Plan Artifact
        inputs:
          path: $(Build.ArtifactStagingDirectory)/$(Build.BuildId)-tfplan.tgz
          artifactName: $(Build.BuildId)-tfplan
